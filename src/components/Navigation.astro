---
import { getCollection } from 'astro:content';
import '../styles/navigation.css';

interface Props {
  isDesktop: boolean;
}

interface NavItem {
  title: string;
  path: string;
  isHeader?: boolean;
  isCity?: boolean;
  cityServices?: NavItem[];
  submenu?: NavItem[];
}

// Map city names to their service page slugs
const cityServiceMap: Record<string, { waterHeater?: string; drainCleaning?: string; plumbing: string }> = {
  'Mill Valley': {
    waterHeater: '/water-heater-installation-and-repair-mill-valley/',
    drainCleaning: '/drain-cleaning-mill-valley/',
    plumbing: '/mill-valley-plumbing/'
  },
  'Novato': {
    waterHeater: '/water-heater-repair-novato/',
    drainCleaning: '/drain-cleaning-novato/',
    plumbing: '/novato-plumbing/'
  },
  'San Rafael': {
    waterHeater: '/water-heater-repair-san-rafael/',
    drainCleaning: '/drain-cleaning-san-rafael/',
    plumbing: '/san-rafael-plumbing/'
  },
  'Healdsburg': {
    waterHeater: '/water-heater-installation-and-repair-healdsburg/',
    drainCleaning: '/drain-cleaning-healdsburg/',
    plumbing: '/healdsburg-plumbing/'
  },
  'Petaluma': {
    waterHeater: '/water-heater-installation-petaluma/',
    drainCleaning: '/drain-cleaning-petaluma/',
    plumbing: '/petaluma-plumbing/'
  },
  'Sonoma': {
    waterHeater: '/water-heater-installation-and-repair-sonoma/',
    drainCleaning: '/drain-cleaning-sonoma/',
    plumbing: '/sonoma-plumbing/'
  },
  'Santa Rosa': {
    waterHeater: '/water-heater-repair-santa-rosa/',
    drainCleaning: '/drain-cleaning-santa-rosa/',
    plumbing: '/santa-rosa-plumbing/'
  }
};

const { isDesktop } = Astro.props;

// "Your Problem?" menu - organized by symptom/situation
const problemMenu: NavItem[] = [
  { title: "I have an EMERGENCY", path: "/emergency-plumbing-services/" },
  { title: "WATER HEATER ISSUES", path: "#", isHeader: true },
  { title: "My Hot Water is Gone", path: "/water-heater-repair-and-replacement/" },
  { title: "Water heater leaking", path: "/water-heater-repair-and-replacement/" },
  { title: "I need a Water Heater", path: "/water-heater-install/" },
  
  { title: "DRAIN PROBLEMS", path: "#", isHeader: true },
  { title: "I need Drain Cleaning", path: "/clogged-drains-rootered/" },
  { title: "Toilet backed up", path: "/clogged-or-running-toilets/" },
  { title: "Multiple Drains Clogged", path: "/sewer-line-repair-and-replacement/" },
  { title: "Garbage Disposal Stopped", path: "/garbage-disposal-repair-or-installation/" },
  
  { title: "LEAKS & PIPES", path: "#", isHeader: true },
  { title: "Leaking Water Heater", path: "/water-heater-repair-and-replacement/" },
  { title: "Wetness or water stains", path: "/leak-detection-and-repair/" },
  { title: "Faucet dripping or leaking", path: "/faucet-leaks-repaired/" },
  { title: "Water bill suddenly high", path: "/leaking-pipes-repair/" },
  
  { title: "OTHER", path: "#", isHeader: true },
  { title: "All Problems & Needs", path: "/all-plumbing-problems/" },
  { title: "View all services", path: "/plumbing-services/" },
];

// "Near Me" menu - simplified location selector with city service submenus
const regions = await getCollection('regions');
const parentRegions = regions.filter(r => !r.data.regionParent && r.data.includeInMenu);
const childRegions = regions.filter(r => r.data.regionParent);

// Helper to build city services submenu
function buildCityServices(cityName: string): NavItem[] {
  const services = cityServiceMap[cityName];
  if (!services) return [];
  
  const cityServices: NavItem[] = [];
  if (services.waterHeater) {
    cityServices.push({ title: "Water Heaters", path: services.waterHeater });
  }
  if (services.drainCleaning) {
    cityServices.push({ title: "Drain Cleaning", path: services.drainCleaning });
  }
  cityServices.push({ title: "Plumbing", path: services.plumbing });
  return cityServices;
}

const nearMeMenu: NavItem[] = [];

// Add Marin County section
const marinParent = parentRegions.find(r => r.data.region === 'Marin County');
if (marinParent) {
  nearMeMenu.push({ title: "All Marin County →", path: `/${marinParent.slug}/`, isHeader: true });
  const marinChildren = childRegions
    .filter(child => child.data.regionParent === 'Marin County')
    .sort((a, b) => (a.data.featureTitle || a.data.region).localeCompare(b.data.featureTitle || b.data.region));
  marinChildren.forEach(child => {
    const cityName = child.data.featureTitle || child.data.region;
    nearMeMenu.push({
      title: cityName,
      path: `/${child.slug}/`,
      isCity: true,
      cityServices: buildCityServices(cityName)
    });
  });
}

// Add Sonoma County section
const sonomaParent = parentRegions.find(r => r.data.region === 'Sonoma County');
if (sonomaParent) {
  nearMeMenu.push({ title: "All Sonoma County →", path: `/${sonomaParent.slug}/`, isHeader: true });
  const sonomaChildren = childRegions
    .filter(child => child.data.regionParent === 'Sonoma County')
    .sort((a, b) => (a.data.featureTitle || a.data.region).localeCompare(b.data.featureTitle || b.data.region));
  sonomaChildren.forEach(child => {
    const cityName = child.data.featureTitle || child.data.region;
    nearMeMenu.push({
      title: cityName,
      path: `/${child.slug}/`,
      isCity: true,
      cityServices: buildCityServices(cityName)
    });
  });
}

// "Us" menu - company information
const usMenu: NavItem[] = [
  { title: "About GoFlow", path: "/about-us/" },
  { title: "Our Team", path: "/team/" },
  { title: "Articles & Tips", path: "/articles/" },
  { title: "FAQs", path: "/faqs/" },
  { title: "Contact Us", path: "/contact-us/" },
];

const navigation: NavItem[] = [
  {
    title: "My Plumbing Problem is...",
    path: "/plumbing-services/",
    submenu: problemMenu
  },
  {
    title: "I Am Near...",
    path: "/service-regions/",
    submenu: nearMeMenu
  },
  {
    title: "Us",
    path: "/about-us/",
    submenu: usMenu
  }
];

const currentPath = Astro.url.pathname;

function isActive(path: string): boolean {
  return currentPath === path || currentPath.startsWith(path + '/');
}
---

{isDesktop ? (
  <ul class="flex space-x-4">
    {navigation.map(item => (
      <li class="relative group">
        <a
          href={item.path}
          class={`nav-link ${isActive(item.path) ? 'nav-active' : ''} ${item.submenu ? 'has-submenu' : ''}`}
        >
          {item.title}
        </a>
        {item.submenu && (
          <div class="submenu-wrapper">
            <ul class="submenu-list">
              {item.submenu.map(subItem => (
                subItem.isHeader ? (
                  <li class="submenu-header">
                    <a href={subItem.path} class="submenu-header-link">{subItem.title}</a>
                  </li>
                ) : subItem.isCity && subItem.cityServices && subItem.cityServices.length > 0 ? (
                  <li class="submenu-city">
                    <button 
                      class={`submenu-city-button ${isActive(subItem.path) ? 'active' : ''}`}
                      onclick="this.closest('.submenu-city').classList.toggle('open')"
                    >
                      <span class="submenu-city-label">{subItem.title}</span>
                      <span class="submenu-city-icon">▼</span>
                    </button>
                    <ul class="submenu-city-services">
                      {subItem.cityServices.map(service => (
                        <li>
                          <a
                            href={service.path}
                            class={`submenu-service-item ${isActive(service.path) ? 'active' : ''}`}
                          >
                            {subItem.title}&nbsp;<strong>{service.title}</strong>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </li>
                ) : (
                  <li>
                    <a
                      href={subItem.path}
                      class={`submenu-item ${isActive(subItem.path) ? 'active' : ''}`}
                    >
                      {subItem.title}
                    </a>
                  </li>
                )
              ))}
            </ul>
          </div>
        )}
      </li>
    ))}
  </ul>
) : (
  <div class="mobile-nav">
    <ul class="mobile-nav-list">
    {navigation.map(item => (
      <li class="mobile-nav-item" data-has-submenu={!!item.submenu}>
        {!item.submenu ? (
          <a
            href={item.path}
            class={`mobile-nav-link ${isActive(item.path) ? 'active' : ''}`}
          >
            {item.title}
          </a>
        ) : (
          <div class="mobile-submenu">
            <button
              class={`mobile-submenu-button ${isActive(item.path) ? 'active' : ''}`}
              onclick="this.closest('.mobile-nav-item').classList.toggle('open')"
            >
              <span>{item.title}</span>
              <span class="mobile-submenu-icon">▼</span>
            </button>
            <div class="mobile-submenu-content">
              <ul class="mobile-submenu-list">
                {item.submenu.map(subItem => (
                  subItem.isHeader ? (
                    <li class="mobile-submenu-header">
                      <a href={subItem.path} class="mobile-submenu-header-link">{subItem.title}</a>
                    </li>
                  ) : subItem.isCity && subItem.cityServices && subItem.cityServices.length > 0 ? (
                    <li class="mobile-city-item">
                      <button 
                        class={`mobile-city-button ${isActive(subItem.path) ? 'active' : ''}`}
                        onclick="this.closest('.mobile-city-item').classList.toggle('open')"
                      >
                        <span class="mobile-city-label">{subItem.title}</span>
                        <span class="mobile-city-icon">▼</span>
                      </button>
                      <ul class="mobile-city-services">
                        {subItem.cityServices.map(service => (
                          <li>
                            <a
                              href={service.path}
                              class={`mobile-service-link ${isActive(service.path) ? 'active' : ''}`}
                            >
                              {service.title}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </li>
                  ) : (
                    <li>
                      <a
                        href={subItem.path}
                        class={`mobile-nav-link ${isActive(subItem.path) ? 'active' : ''}`}
                      >
                        {subItem.title}
                      </a>
                    </li>
                  )
                ))}
              </ul>
            </div>
          </div>
        )}
      </li>
    ))}
  </ul>
  </div>
)}


