---
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { createArticlePageSchema, createBreadcrumbSchema } from '../lib/schema/factories';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import AnatomyNav from '@/components/AnatomyNav.astro';
import '../styles/articles.css';

interface Props {
  article: CollectionEntry<'articles'>;
}

const { article } = Astro.props;
const isAnatomyArticle = article.slug.startsWith('anatomy-of-a-water-heater');
const { Content } = await article.render();

// Always use the schema factory to ensure consistent formatting
const articleDetails = {
  title: article.data.title,
  description: article.data.description,
  url: `https://goflow.plumbing/articles/${article.slug}/`,
  imageUrl: article.data.heroImage,
  publishDate: article.data.pubDate,
  modifyDate: article.data.updatedDate
};

const schema = await createArticlePageSchema(articleDetails);

// Breadcrumbs: Home > Articles > Current article (prefers breadcrumbDisplayText if provided)
const currentCrumbName = article.data.breadcrumbDisplayText ?? article.data.linkText ?? article.data.menuText ?? article.data.title;
const pageUrl = `https://goflow.plumbing/articles/${article.slug}/`;
const breadcrumbSchema = await createBreadcrumbSchema([
  { name: 'Home', url: 'https://goflow.plumbing/' },
  { name: 'Articles', url: 'https://goflow.plumbing/articles/' },
  { name: currentCrumbName, url: pageUrl }
]);
const combinedSchema = [schema, breadcrumbSchema];
---

<BaseLayout 
  title={article.data.title}
  description={article.data.description}
  schema={combinedSchema}
>
<article class="article">
    <Breadcrumbs items={[{ name: 'Home', path: '/' }, { name: 'Articles', path: '/articles/' }, { name: currentCrumbName }]} />
    {article.data.heroImage && (
      <div class="mb-8">
        <img
          src={article.data.heroImage}
          alt={article.data.title}
          loading="eager"
          decoding="async"
          fetchpriority="high"
        />
      </div>
    )}
    {isAnatomyArticle && <AnatomyNav currentSlug={article.slug} />}
    <div class="markdown-content">
      <Content />
    </div>
    <div class="call-to-action">
      <h2>Need Professional Plumbing Help?</h2>
      <p>Our expert plumbers are ready to assist with any plumbing issue.</p>
      <a href="/contact-us/">Schedule Service</a>
    </div>
  </article>
</BaseLayout>
