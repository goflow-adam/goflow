---
import { getCollection } from 'astro:content';
import { sortByPositionThenTitle } from '../lib/sortByPositionThenTitle';
import '../styles/navigation.css';

interface Props {
  isDesktop: boolean;
}

interface NavItem {
  title: string;
  path: string;
  position?: number;
  submenu?: NavItem[];
}

const { isDesktop } = Astro.props;
// Get all service pages and sort them by title
const services = await getCollection('services');
const serviceMenuUnsorted = services
  .filter(service => service.data.includeInMenu)
  .map(service => ({
    title: service.data.menuText || service.data.linkText || service.data.title,
    path: `/${service.slug}/`,
    position: service.data.position
  }));

const serviceMenu = sortByPositionThenTitle(
  serviceMenuUnsorted,
  item => item.position,
  item => item.title
);

// Get all region pages and build hierarchical menu
const regions = await getCollection('regions');

// Separate parent regions (no regionParent) from child regions (have regionParent)
const parentRegions = regions.filter(r => !r.data.regionParent && r.data.includeInMenu);
const childRegions = regions.filter(r => r.data.regionParent);

// Build hierarchical region menu
const regionMenu: NavItem[] = [];

parentRegions
  .sort((a, b) => (a.data.featureTitle || a.data.region).localeCompare(b.data.featureTitle || b.data.region))
  .forEach(parent => {
    // Add parent with "All " prefix
    regionMenu.push({
      title: `All ${parent.data.featureTitle || parent.data.region}`,
      path: `/${parent.slug}/`
    });
    
    // Add children that belong to this parent
    const children = childRegions
      .filter(child => child.data.regionParent === parent.data.region)
      .sort((a, b) => (a.data.featureTitle || a.data.region).localeCompare(b.data.featureTitle || b.data.region));
    
    children.forEach(child => {
      regionMenu.push({
        title: child.data.featureTitle || child.data.region,
        path: `/${child.slug}/`
      });
    });
  });

// Get all articles and sort them by date
const articles = await getCollection('articles');
const articleMenu = articles
  .filter(article => !article.data.draft) // Only show published articles
  .filter(service => service.data.includeInMenu)
  .map(article => ({
    title: article.data.linkText || article.data.title,
    path: `/articles/${article.slug}/`
  }))
  .sort((a, b) => a.title.localeCompare(b.title));

const navigation: NavItem[] = [
  {
    title: "Services",
    path: "/plumbing-services/",
    submenu: serviceMenu
  },
  {
    title: "Regions",
    path: "/service-regions/",
    submenu: regionMenu
  },
  {
    title: "Articles",
    path: "/articles/",
    submenu: articleMenu
  },
  { title: "Contact Us", path: "/contact-us/" },
  { title: "FAQs", path: "/faqs/" }
];

const currentPath = Astro.url.pathname;

function isActive(path: string): boolean {
  return currentPath === path || currentPath.startsWith(path + '/');
}
---

{isDesktop ? (
  <ul class="flex space-x-4">
    {navigation.map(item => (
      <li class="relative group">
        <a
          href={item.path}
          class={`nav-link ${isActive(item.path) ? 'nav-active' : ''} ${item.submenu ? 'has-submenu' : ''}`}
        >
          {item.title}
        </a>
        {item.submenu && (
          <div class="submenu-wrapper">
            <ul class="submenu-list">
              {item.submenu.map(subItem => (
                <li>
                  <a
                    href={subItem.path}
                    class={`submenu-item ${isActive(subItem.path) ? 'active' : ''}`}
                  >
                    {subItem.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}
      </li>
    ))}
  </ul>
) : (
  <div class="mobile-nav">
    <ul class="mobile-nav-list">
    {navigation.map(item => (
      <li class="mobile-nav-item" data-has-submenu={!!item.submenu}>
        {!item.submenu ? (
          <a
            href={item.path}
            class={`mobile-nav-link ${isActive(item.path) ? 'active' : ''}`}
          >
            {item.title}
          </a>
        ) : (
          <div class="mobile-submenu">
            <button
              class={`mobile-submenu-button ${isActive(item.path) ? 'active' : ''}`}
              onclick="this.closest('.mobile-nav-item').classList.toggle('open')"
            >
              <span>{item.title}</span>
              <span class="mobile-submenu-icon">â–¼</span>
            </button>
            <div class="mobile-submenu-content">
              <ul class="mobile-submenu-list">
                {item.path === '/plumbing-services/' && (
                  <li>
                    <a
                      href="/plumbing-services/"
                      class={`mobile-nav-link ${isActive('/plumbing-services/') ? 'active' : ''}`}
                    >
                      Services Home
                    </a>
                  </li>
                )}
                {item.path === '/service-regions/' && (
                  <li>
                    <a
                      href="/service-regions/"
                      class={`mobile-nav-link ${isActive('/service-regions/') ? 'active' : ''}`}
                    >
                      Regions Home
                    </a>
                  </li>
                )}
                {item.path === '/articles/' && (
                  <li>
                    <a
                      href="/articles/"
                      class={`mobile-nav-link ${isActive('/articles/') ? 'active' : ''}`}
                    >
                      Articles Home
                    </a>
                  </li>
                )}
                {item.submenu.map(subItem => (
                  <li>
                    <a
                      href={subItem.path}
                      class={`mobile-nav-link ${isActive(subItem.path) ? 'active' : ''}`}
                    >
                      {subItem.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        )}
      </li>
    ))}
  </ul>
  </div>
)}


